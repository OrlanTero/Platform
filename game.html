<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="screen-orientation" content="landscape">
    <meta name="full-screen" content="yes">
    <meta name="browsermode" content="application">
    <title>Platform Game - Play</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            touch-action: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            background: #1a1a1a;
        }

        #game-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            margin: 0;
            padding: 0;
            background: #1a1a1a;
        }
        
        #game-canvas {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        /* Top bar buttons */
        .top-button {
            position: absolute;
            top: 16px;
            font-size: 32px;
            cursor: pointer;
            z-index: 1000;
            -webkit-text-stroke: 4px #000;
            color: #ffffff;
            user-select: none;
            pointer-events: auto;
        }
        
        #back-button {
            right: 112px;
        }
        
        #fullscreen-button {
            right: 64px;
        }
        
        #pause-button {
            right: 16px;
        }
        
        #loading {
            position: absolute;
            color: white;
            font-size: 24px;
            z-index: 1000;
        }
        
        #back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1000;
            font-size: 16px;
        }
        
        #back-button:active {
            background: rgba(255, 255, 255, 0.2);
        }
        
        /* Hide scrollbars */
        ::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>
<body>
    <div id="loading">Loading...</div>
    <div id="game-container"></div>
    
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js"></script>
    <script src="levels/levels-config.js"></script>
    <script src="game-with-custom-map.js?v=80"></script>
    
    <script>

        // Function to detect mobile devices
        function isMobileDevice() {
            return (typeof window.orientation !== "undefined") || 
                   (navigator.userAgent.match(/Android/i) ||
                    navigator.userAgent.match(/webOS/i) ||
                    navigator.userAgent.match(/iPhone/i) ||
                    navigator.userAgent.match(/iPad/i) ||
                    navigator.userAgent.match(/iPod/i) ||
                    navigator.userAgent.match(/BlackBerry/i) ||
                    navigator.userAgent.match(/Windows Phone/i));
        }

        // Function to handle orientation changes
        function handleOrientation() {
            const orientationMessage = document.getElementById('orientation-message');
            const gameContainer = document.getElementById('game-container');
            const isPortrait = window.innerHeight > window.innerWidth;
            
            // Improved fullscreen function with better error handling
            const tryFullscreen = () => {
                if (!document.fullscreenElement) {
                    const elem = document.documentElement;
                    const requestFullscreen = elem.requestFullscreen || 
                                            elem.webkitRequestFullscreen || 
                                            elem.mozRequestFullScreen || 
                                            elem.msRequestFullscreen;
                    
                    if (requestFullscreen) {
                        requestFullscreen.call(elem).then(() => {
                            console.log('Entered fullscreen mode');
                            // Lock orientation to landscape after entering fullscreen
                            if (screen.orientation && screen.orientation.lock) {
                                screen.orientation.lock('landscape').catch(err => {
                                    console.log('Orientation lock failed:', err);
                                });
                            }
                        }).catch(err => {
                            console.log('Fullscreen request failed:', err);
                        });
                    }
                }
            };
            
            if (isMobileDevice() && isPortrait) {
                // Show orientation message
                if (!orientationMessage) {
                    const msg = document.createElement('div');
                    msg.id = 'orientation-message';
                    msg.innerHTML = `
                        <div style="text-align: center;">
                            <div style="font-size: 48px; margin-bottom: 20px;">ðŸ“±</div>
                            <div style="font-size: 24px; font-weight: bold; margin-bottom: 10px;">Please Rotate Your Device</div>
                            <div style="font-size: 16px; opacity: 0.8;">This game is best played in landscape mode</div>
                        </div>
                    `;
                    msg.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: #1a1a1a;
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        color: white;
                        text-align: center;
                        padding: 20px;
                        z-index: 9999;
                        font-family: Arial, sans-serif;
                    `;
                    document.body.appendChild(msg);
                }
                
                // Hide game container
                if (gameContainer) {
                    gameContainer.style.display = 'none';
                }
                
                return false;
            } else {
                // Hide orientation message if visible
                const orientationMessage = document.getElementById('orientation-message');
                if (orientationMessage) {
                    orientationMessage.remove();
                }
                
                // Show game container
                if (gameContainer) {
                    gameContainer.style.display = 'flex';
                    
                    // Try to enter fullscreen when in landscape on mobile
                    if (isMobileDevice() && !document.fullscreenElement) {
                        // Delay fullscreen request slightly to ensure proper orientation
                        setTimeout(() => {
                            tryFullscreen();
                        }, 300);
                    }
                }
                
                // Show fullscreen button
                const fullscreenButton = document.getElementById('fullscreen-button');
                if (fullscreenButton) {
                    fullscreenButton.style.display = 'block';
                }
                
                return true;
            }
        }
        
        // Toggle fullscreen with cross-browser support
        function toggleFullscreen() {
            const isFullscreen = document.fullscreenElement || 
                               document.webkitFullscreenElement || 
                               document.mozFullScreenElement || 
                               document.msFullscreenElement;
            
            if (!isFullscreen) {
                const elem = document.documentElement;
                const requestFullscreen = elem.requestFullscreen || 
                                        elem.webkitRequestFullscreen || 
                                        elem.mozRequestFullScreen || 
                                        elem.msRequestFullscreen;
                
                if (requestFullscreen) {
                    requestFullscreen.call(elem).then(() => {
                        console.log('Entered fullscreen');
                        // Try to lock orientation to landscape
                        if (screen.orientation && screen.orientation.lock) {
                            screen.orientation.lock('landscape').catch(err => {
                                console.log('Orientation lock failed:', err);
                            });
                        }
                    }).catch(err => {
                        console.log('Fullscreen error:', err);
                    });
                }
            } else {
                const exitFullscreen = document.exitFullscreen || 
                                     document.webkitExitFullscreen || 
                                     document.mozCancelFullScreen || 
                                     document.msExitFullscreen;
                
                if (exitFullscreen) {
                    exitFullscreen.call(document).catch(err => {
                        console.log('Exit fullscreen error:', err);
                    });
                }
            }
        }

        // Function to get URL parameters
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            const results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        // Function to load level data
        async function loadLevelData(level) {
            try {
                const levelConfig = LEVELS_CONFIG.levels.find(l => l.id === level);
                if (!levelConfig) throw new Error('Level not found');
                
                const response = await fetch(levelConfig.file);
                if (!response.ok) throw new Error('Failed to load level data');
                
                return await response.json();
            } catch (error) {
                console.error('Error loading level:', error);
                return null;
            }
        }

        // Function to get current level from URL
        function getCurrentLevel() {
            const level = parseInt(getUrlParameter('level') || '1');
            return Math.max(1, Math.min(level, LEVELS_CONFIG.levels.length));
        }

        // Function to check if level is unlocked
        function isLevelUnlocked(level) {
            if (level === 1) return true;
            const unlockedLevels = JSON.parse(localStorage.getItem('unlockedLevels') || '[]');
            return unlockedLevels.includes(level);
        }

        // Game launcher - loads level and starts game
        async function startGame() {
            const loadingEl = document.getElementById('loading');
            
            try {
                // Check if this is test mode from editor
                const isTestMode = getUrlParameter('test') === 'true';
                
                let levelData;
                let currentLevel;
                
                if (isTestMode) {
                    // Test mode: Load from localStorage (editor preview)
                    loadingEl.textContent = 'Loading Test Map...';
                    const savedMap = localStorage.getItem('customMap');
                    
                    if (!savedMap) {
                        throw new Error('No test map found in localStorage');
                    }
                    
                    levelData = JSON.parse(savedMap);
                    currentLevel = 0; // Test level
                    console.log('ðŸŽ® Test mode: Loaded map from localStorage');
                } else {
                    // Normal mode: Load from level files
                    currentLevel = getCurrentLevel();
                    
                    // Check if level is unlocked
                    if (!isLevelUnlocked(currentLevel)) {
                        alert(`Level ${currentLevel} is locked! Complete previous levels first.`);
                        window.location.href = 'index.html';
                        return;
                    }
                    
                    loadingEl.textContent = `Loading Level ${currentLevel}...`;
                    
                    // Load level data
                    levelData = await loadLevelData(currentLevel);
                    
                    if (!levelData) {
                        throw new Error('Failed to load level data');
                    }
                }
                
                loadingEl.style.display = 'none';
                
                // Check if game instance already exists
                if (!window.gameInstance) {
                    // Start Phaser game with level data
                    const config = {
                        type: Phaser.AUTO,
                        width: 800,
                        height: 600,
                        parent: "game-container",
                        backgroundColor: "#87CEEB",
                        physics: {
                            default: "arcade",
                            arcade: {
                                gravity: { y: 0 },
                                debug: false,
                            },
                        },
                        input: {
                            activePointers: 5, // Support up to 5 simultaneous touches
                            touch: {
                                target: null,
                                capture: true
                            },
                            mouse: {
                                target: null,
                                capture: true
                            }
                        },
                        scale: {
                            mode: Phaser.Scale.FIT,
                            autoCenter: Phaser.Scale.CENTER_BOTH,
                            width: '100%',
                            height: '100%',
                            min: {
                                width: 320,
                                height: 480
                            },
                            max: {
                                width: 1920,
                                height: 1080
                            }
                        },
                        scene: GameScene,
                        // Disable auto-start of the scene
                        scene: {
                            create: function() {
                                // Scene will be started manually
                            }
                        }
                    };

                    // Store game instance globally to prevent multiple instances
                    window.gameInstance = new Phaser.Game(config);
                }
                
                // Start the scene with level data
                if (window.gameInstance.scene.getScenes().length > 0) {
                    // If scene already exists, restart it with new level data
                    window.gameInstance.scene.getScenes()[0].scene.restart({ 
                        levelData: levelData,
                        level: currentLevel 
                    });
                } else {
                    // Otherwise, start a new scene
                    window.gameInstance.scene.add('GameScene', GameScene, true, { 
                        levelData: levelData,
                        level: currentLevel 
                    });
                }
                
            } catch (error) {
                console.error('Error starting game:', error);
                loadingEl.textContent = 'Error loading game. Redirecting to menu...';
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
            }
        }

     

  

        // Handle fullscreen change events with cross-browser support
        const fullscreenChangeHandler = () => {
            const fullscreenButton = document.getElementById('fullscreen-button');
            const isFullscreen = document.fullscreenElement || 
                               document.webkitFullscreenElement || 
                               document.mozFullScreenElement || 
                               document.msFullscreenElement;
            
            if (fullscreenButton) {
                fullscreenButton.innerHTML = isFullscreen ? 'â›¶' : 'â›¶';
                fullscreenButton.style.opacity = isFullscreen ? '0.7' : '1';
            }
            
            // Update game scale if needed
            if (window.gameInstance) {
                window.gameInstance.scale.updateBounds();
            }
        };
        
        document.addEventListener('fullscreenchange', fullscreenChangeHandler);
        document.addEventListener('webkitfullscreenchange', fullscreenChangeHandler);
        document.addEventListener('mozfullscreenchange', fullscreenChangeHandler);
        document.addEventListener('MSFullscreenChange', fullscreenChangeHandler);

        // Initial check and start
        if (handleOrientation()) {
            startGame();
        }
        
        // Add orientation change listeners
        window.addEventListener('orientationchange', () => {
            console.log('Orientation changed');
            setTimeout(() => {
                if (handleOrientation()) {
                    if (!window.gameInstance) {
                        startGame();
                    }
                }
            }, 100);
        });
        
        window.addEventListener('resize', () => {
            handleOrientation();
            if (window.gameInstance) {
                window.gameInstance.scale.updateBounds();
            }
        });
        
        // Handle page visibility changes (for mobile devices)
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                handleOrientation();
            }
        });
        
        // Add touch event to trigger fullscreen on mobile (user gesture required)
        if (isMobileDevice()) {
            let firstTouch = true;
            document.addEventListener('touchstart', function enableFullscreen() {
                if (firstTouch && !document.fullscreenElement) {
                    firstTouch = false;
                    const elem = document.documentElement;
                    const requestFullscreen = elem.requestFullscreen || 
                                            elem.webkitRequestFullscreen || 
                                            elem.mozRequestFullScreen || 
                                            elem.msRequestFullscreen;
                    
                    if (requestFullscreen) {
                        requestFullscreen.call(elem).catch(err => {
                            console.log('Initial fullscreen request failed:', err);
                        });
                    }
                }
            }, { once: true });
        }
    </script>
</body>
</html>
