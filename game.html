<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Platform Game - Play</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            touch-action: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            background: #1a1a1a;
        }

        #game-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        #loading {
            position: absolute;
            color: white;
            font-size: 24px;
            z-index: 1000;
        }
        
        #back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 12px 24px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            cursor: pointer;
            z-index: 1000;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.2s ease;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        
        /* Responsive button size */
        @media (max-width: 768px) {
            #back-button {
                padding: 15px 25px;
                font-size: 20px;
                top: 10px;
                left: 10px;
            }
        }
        
        /* For very small devices */
        @media (max-width: 480px) {
            #back-button {
                padding: 10px 20px;
                font-size: 16px;
            }
        }
        
        #back-button:active {
            background: rgba(255, 255, 255, 0.2);
        }
        
        /* Hide scrollbars */
        ::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>
<body>
    <button id="back-button">Back to Menu</button>
    <div id="loading">Loading...</div>
    <div id="game-container"></div>
    <div id="jump-button">JUMP</div>
    
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js"></script>
    <script src="levels/levels-config.js"></script>
    <script src="game-with-custom-map.js"></script>
    
    <style>
        /* Jump button */
        #jump-button {
            position: fixed;
            right: 30px;
            bottom: 40px;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: rgba(76, 175, 80, 0.5);
            border: 3px solid rgba(255, 255, 255, 0.5);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            opacity: 0.7;
            transition: transform 0.1s, opacity 0.2s;
        }
        
        #jump-button:active {
            transform: scale(0.9);
            opacity: 1;
        }
        
        /* Hide controls on non-touch devices */
        @media (hover: hover) and (pointer: fine) {
            #jump-button {
                display: none;
            }
        }
    </style>
    
    <script>
        // Back to menu button
        document.getElementById('back-button').addEventListener('click', function() {
            // Destroy the game instance if it exists
            if (window.gameInstance) {
                window.gameInstance.destroy(true);
                window.gameInstance = null;
            }
            window.location.href = 'index.html';
        });

        // Function to detect mobile devices
        function isMobileDevice() {
            return (typeof window.orientation !== "undefined") || (navigator.userAgent.indexOf('IEMobile') !== -1);
        }

        // Function to toggle fullscreen
        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                const element = document.documentElement;
                if (element.requestFullscreen) {
                    element.requestFullscreen().catch(err => {
                        console.error(`Error attempting to enable fullscreen: ${err.message}`);
                    });
                }
            }
        }

        // Function to handle orientation changes
        function handleOrientation() {
            if (isMobileDevice()) {
                const orientationMessage = document.getElementById('orientation-message');
                const gameContainer = document.getElementById('game-container');
                const backButton = document.getElementById('back-button');
                
                const isPortrait = window.innerHeight > window.innerWidth;
                
                if (isPortrait) {
                    // Show orientation message
                    if (!orientationMessage) {
                        const msg = document.createElement('div');
                        msg.id = 'orientation-message';
                        msg.innerHTML = 'Please rotate your device to landscape mode for the best experience';
                        msg.style.cssText = `
                            position: fixed;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            background: #1a1a1a;
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            color: white;
                            font-size: 24px;
                            text-align: center;
                            padding: 20px;
                            z-index: 9999;
                        `;
                        document.body.appendChild(msg);
                    }
                    
                    // Hide game container and back button
                    if (gameContainer) gameContainer.style.display = 'none';
                    if (backButton) backButton.style.display = 'none';
                    
                    // Try to lock orientation (works on some devices)
                    if (screen.orientation?.lock) {
                        screen.orientation.lock('landscape').catch(() => {
                            console.log('Orientation lock not supported');
                        });
                    }
                    
                    return false;
                } else {
                    // Hide orientation message if visible
                    const orientationMessage = document.getElementById('orientation-message');
                    if (orientationMessage) {
                        orientationMessage.remove();
                    }
                    
                    // Show game container and back button
                    if (gameContainer) gameContainer.style.display = 'flex';
                    if (backButton) backButton.style.display = 'block';
                    
                    // Enter fullscreen in landscape
                    toggleFullScreen();
                    
                    return true;
                }
            } else {
                // For desktop or non-mobile, just ensure the game is visible
                const gameContainer = document.getElementById('game-container');
                const backButton = document.getElementById('back-button');
                if (gameContainer) gameContainer.style.display = 'flex';
                if (backButton) backButton.style.display = 'block';
                return true;
            }
        }

        // Function to get URL parameters
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            const results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        // Function to load level data
        async function loadLevelData(level) {
            try {
                const levelConfig = LEVELS_CONFIG.levels.find(l => l.id === level);
                if (!levelConfig) throw new Error('Level not found');
                
                const response = await fetch(levelConfig.file);
                if (!response.ok) throw new Error('Failed to load level data');
                
                return await response.json();
            } catch (error) {
                console.error('Error loading level:', error);
                return null;
            }
        }

        // Function to get current level from URL
        function getCurrentLevel() {
            const level = parseInt(getUrlParameter('level') || '1');
            return Math.max(1, Math.min(level, LEVELS_CONFIG.levels.length));
        }

        // Function to check if level is unlocked
        function isLevelUnlocked(level) {
            if (level === 1) return true;
            const unlockedLevels = JSON.parse(localStorage.getItem('unlockedLevels') || '[]');
            return unlockedLevels.includes(level);
        }

        // Jump button reference
        let jumpButton = null;
        
        // Function to initialize mobile controls
        function initMobileControls() {
            // Only initialize on mobile devices
            if (!('ontouchstart' in window || navigator.maxTouchPoints > 0)) {
                return;
            }
            
            // Initialize jump button
            jumpButton = document.getElementById('jump-button');
            if (jumpButton) {
                const handleJumpStart = () => {
                    if (window.gameInstance) {
                        const scene = window.gameInstance.scene.getScene('GameScene');
                        if (scene) {
                            scene.handleJump();
                            scene.joystickJump = true;
                            // Reset jump after a short delay to allow for jump buffer
                            setTimeout(() => { 
                                scene.joystickJump = false; 
                            }, 100);
                        }
                    }
                };
                
                // Add touch events
                jumpButton.addEventListener('touchstart', handleJumpStart);
                jumpButton.addEventListener('touchend', (e) => e.preventDefault());
                jumpButton.addEventListener('click', handleJumpStart);
            }
        }
        
        // Game launcher - loads level and starts game
        async function startGame() {
            const loadingEl = document.getElementById('loading');
            
            try {
                // Initialize mobile controls after a short delay to ensure game is loaded
                setTimeout(initMobileControls, 500);
                // Get level from URL parameter
                const currentLevel = getCurrentLevel();
                
                // Check if level is unlocked
                if (!isLevelUnlocked(currentLevel)) {
                    alert(`Level ${currentLevel} is locked! Complete previous levels first.`);
                    // window.location.href = 'index.html';
                    return;
                }
                
                loadingEl.textContent = `Loading Level ${currentLevel}...`;
                
                // Load level data
                const levelData = await loadLevelData(currentLevel);
                
                if (!levelData) {
                    throw new Error('Failed to load level data');
                }
                
                loadingEl.style.display = 'none';
                
                // If game instance exists, remove it first
                if (window.gameInstance) {
                    window.gameInstance.destroy(true);
                    window.gameInstance = null;
                }

                // Create new game instance with the level data
                const config = {
                    type: Phaser.AUTO,
                    width: 800,
                    height: 600,
                    parent: "game-container",
                    backgroundColor: "#87CEEB",
                    physics: {
                        default: "arcade",
                        arcade: {
                            gravity: { y: 1200 },
                            debug: false,
                        },
                    },
                    scale: {
                        mode: Phaser.Scale.FIT,
                        autoCenter: Phaser.Scale.CENTER_BOTH,
                        width: '100%',
                        height: '100%',
                        min: {
                            width: 320,
                            height: 480
                        },
                        max: {
                            width: 1920,
                            height: 1080
                        }
                    },
                    // Configure the scene with level data
                    scene: [{
                        key: 'BootScene',
                        create: function() {
                            // Start the GameScene with level data
                            this.scene.start('GameScene', { 
                                levelData: levelData,
                                level: currentLevel 
                            });
                        }
                    }, GameScene]
                };

                // Create and store the game instance
                window.gameInstance = new Phaser.Game(config);
                
            } catch (error) {
                console.error('Error starting game:', error);
                loadingEl.textContent = 'Error loading game. Redirecting to menu...';
             
            }
        }

        // Initial check and start
        if (handleOrientation()) {
            startGame();
        } else {
            // If in portrait, wait for orientation change
            const orientationChangeHandler = function() {
                if (handleOrientation()) {
                    window.removeEventListener('orientationchange', orientationChangeHandler);
                    startGame();
                }
            };
            window.addEventListener('orientationchange', orientationChangeHandler);
            
            // Also check for resize events to handle device rotation
            window.addEventListener('resize', function resizeHandler() {
                if (handleOrientation()) {
                    window.removeEventListener('resize', resizeHandler);
                    if (!window.gameInstance) {
                        startGame();
                    }
                }
            });
        }

        // Handle window resize and fullscreen changes
        function handleResize() {
            if (window.gameInstance) {
                const game = window.gameInstance;
                game.scale.updateBounds();
                
                // Force resize the game canvas
                if (game.scene && game.scene.scenes.length > 0) {
                    game.scene.scenes.forEach(scene => {
                        if (scene.cameras && scene.cameras.main) {
                            scene.cameras.main.setViewport(0, 0, game.scale.width, game.scale.height);
                        }
                    });
                }
                
                // Reinitialize joystick on resize
                if (joystick) {
                    joystick.destroy();
                    joystick = null;
                }
                if (isMobileDevice()) {
                    initJoystick();
                }
            }
            
            // Update orientation on resize as well
            handleOrientation();
        }
        
        // Add event listeners for resize and fullscreen changes
        window.addEventListener('resize', handleResize);
        document.addEventListener('fullscreenchange', handleResize);
        document.addEventListener('webkitfullscreenchange', handleResize);
        document.addEventListener('mozfullscreenchange', handleResize);
        document.addEventListener('MSFullscreenChange', handleResize);
    </script>
</body>
</html>
