<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="screen-orientation" content="landscape">
    <meta name="full-screen" content="yes">
    <meta name="x5-fullscreen" content="true">
    <meta name="x5-page-mode" content="app">
    <meta name="x5-orientation" content="landscape">
    <title>Platform Game - Play</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            touch-action: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            background: #1a1a1a;
        }

        #game-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            background: #000;
        }
        
        /* Landscape orientation warning for mobile */
        #orientation-warning {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            color: white;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            z-index: 9999;
            font-size: 24px;
            font-family: Arial, sans-serif;
        }
        
        @media screen and (max-width: 768px) and (orientation: portrait) {
            #orientation-warning {
                display: flex;
            }
            #game-container {
                display: none;
            }
        }
        
        #loading {
            position: absolute;
            color: white;
            font-size: 24px;
            z-index: 1000;
        }
        
        #back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1000;
            font-size: 16px;
        }
        
        #back-button:active {
            background: rgba(255, 255, 255, 0.2);
        }
        
        /* Hide scrollbars */
        ::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>
<body>
    <button id="back-button">Back to Menu</button>
    <div id="loading">Loading...</div>
    <div id="orientation-warning">
        <div>
            <h2>Please rotate your device to landscape mode</h2>
            <p>This game is best played in landscape mode on mobile devices.</p>
        </div>
    </div>
    <div id="game-container"></div>
    
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js"></script>
    <script src="levels/levels-config.js"></script>
    <!-- Using game-with-custom-map.js which has the updated controls -->
    <script src="game-with-custom-map.js"></script>
    
    <script>
        // Back to menu button
        document.getElementById('back-button').addEventListener('click', function() {
            // Destroy the game instance if it exists
            if (window.gameInstance) {
                window.gameInstance.destroy(true);
                window.gameInstance = null;
            }
            window.location.href = 'index.html';
        });

        // Function to detect mobile devices
        function isMobileDevice() {
            return (typeof window.orientation !== "undefined") || (navigator.userAgent.indexOf('IEMobile') !== -1);
        }

        // Function to handle orientation changes
        function handleOrientation() {
            if (isMobileDevice()) {
                const orientationMessage = document.getElementById('orientation-message');
                const gameContainer = document.getElementById('game-container');
                
                const isPortrait = window.innerHeight > window.innerWidth;
                
                if (isPortrait) {
                    // Show orientation message
                    if (!orientationMessage) {
                        const msg = document.createElement('div');
                        msg.id = 'orientation-message';
                        msg.innerHTML = 'Please rotate your device to landscape mode';
                        msg.style.cssText = `
                            position: fixed;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            background: #1a1a1a;
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            color: white;
                            font-size: 24px;
                            text-align: center;
                            padding: 20px;
                            z-index: 9999;
                        `;
                        document.body.appendChild(msg);
                    }
                    
                    // Hide game container
                    if (gameContainer) {
                        gameContainer.style.display = 'none';
                    }
                    
                    // Try to lock orientation (works on some devices)
                    if (screen.orientation && screen.orientation.lock) {
                        screen.orientation.lock('landscape').catch(() => {
                            console.log('Orientation lock not supported');
                        });
                    }
                    
                    return false;
                } else {
                    // Hide orientation message if visible
                    const orientationMessage = document.getElementById('orientation-message');
                    if (orientationMessage) {
                        orientationMessage.remove();
                    }
                    
                    // Show game container
                    if (gameContainer) {
                        gameContainer.style.display = 'flex';
                    }
                    
                    return true;
                }
            }
            return true;
        }

        // Function to get URL parameters
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            const results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        // Function to load level data
        async function loadLevelData(level) {
            try {
                const levelConfig = LEVELS_CONFIG.levels.find(l => l.id === level);
                if (!levelConfig) throw new Error('Level not found');
                
                const response = await fetch(levelConfig.file);
                if (!response.ok) throw new Error('Failed to load level data');
                
                return await response.json();
            } catch (error) {
                console.error('Error loading level:', error);
                return null;
            }
        }

        // Function to get current level from URL
        function getCurrentLevel() {
            const level = parseInt(getUrlParameter('level') || '1');
            return Math.max(1, Math.min(level, LEVELS_CONFIG.levels.length));
        }

        // Function to check if level is unlocked
        function isLevelUnlocked(level) {
            if (level === 1) return true;
            const unlockedLevels = JSON.parse(localStorage.getItem('unlockedLevels') || '[]');
            return unlockedLevels.includes(level);
        }

        // Game launcher - loads level and starts game
        async function startGame() {
            const loadingEl = document.getElementById('loading');
            
            try {
                // Get level from URL parameter
                const currentLevel = getCurrentLevel();
                
                // Check if level is unlocked
                if (!isLevelUnlocked(currentLevel)) {
                    alert(`Level ${currentLevel} is locked! Complete previous levels first.`);
                    window.location.href = 'index.html';
                    return;
                }
                
                loadingEl.textContent = `Loading Level ${currentLevel}...`;
                
                // Load level data
                const levelData = await loadLevelData(currentLevel);
                
                if (!levelData) {
                    throw new Error('Failed to load level data');
                }
                
                loadingEl.style.display = 'none';
                
                // Check if game instance already exists
                if (!window.gameInstance) {
                    // Start Phaser game with level data
                    const config = {
                        type: Phaser.AUTO,
                        width: 800,
                        height: 600,
                        parent: "game-container",
                        backgroundColor: "#87CEEB",
                        physics: {
                            default: "arcade",
                            arcade: {
                                gravity: { y: 0 },
                                debug: false,
                            },
                        },
                        scale: {
                            mode: Phaser.Scale.FIT,
                            autoCenter: Phaser.Scale.CENTER_BOTH,
                            width: '100%',
                            height: '100%',
                            min: {
                                width: 320,
                                height: 480
                            },
                            max: {
                                width: 1920,
                                height: 1080
                            }
                        },
                        scene: GameScene,
                        // Disable auto-start of the scene
                        scene: {
                            create: function() {
                                // Scene will be started manually
                            }
                        }
                    };

                    // Store game instance globally to prevent multiple instances
                    window.gameInstance = new Phaser.Game(config);
                }
                
                // Start the scene with level data
                if (window.gameInstance.scene.getScenes().length > 0) {
                    // If scene already exists, restart it with new level data
                    window.gameInstance.scene.getScenes()[0].scene.restart({ 
                        levelData: levelData,
                        level: currentLevel 
                    });
                } else {
                    // Otherwise, start a new scene
                    window.gameInstance.scene.add('GameScene', GameScene, true, { 
                        levelData: levelData,
                        level: currentLevel 
                    });
                }
                
            } catch (error) {
                console.error('Error starting game:', error);
                loadingEl.textContent = 'Error loading game. Redirecting to menu...';
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
            }
        }

        // Initial check and start
        if (handleOrientation()) {
            startGame();
        } else {
            // If in portrait, wait for orientation change
            window.addEventListener('orientationchange', function orientationChange() {
                if (handleOrientation()) {
                    window.removeEventListener('orientationchange', orientationChange);
                    startGame();
                }
            });
        }

        // Handle window resize
        window.addEventListener('resize', function() {
            if (window.gameInstance) {
                window.gameInstance.scale.updateBounds();
            }
        });
    </script>
</body>
</html>
